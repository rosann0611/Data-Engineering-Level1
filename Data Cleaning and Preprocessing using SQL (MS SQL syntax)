-- To check the csv data imported
--select pan_numbers from [dbo].[PAN Number Validation Dataset];

1. Identifying and Handling missing data
select pan_numbers from [dbo].[PAN Number Validation Dataset] where pan_numbers is NOT NULL;

2. Check for duplicates
select pan_numbers, count(1) AS count from [dbo].[PAN Number Validation Dataset] group by pan_numbers having count(1) > 2;

3. Handle leading/trailing spaces
select * from [dbo].[PAN Number Validation Dataset]  where pan_numbers <> trim(pan_numbers);

4. Check letter case
SELECT * FROM [dbo].[PAN Number Validation Dataset] WHERE pan_numbers COLLATE Latin1_General_CS_AS <> UPPER(pan_numbers);

---------------------------------------------
--Final Query for Data Cleaning

SELECT DISTINCT UPPER(TRIM(pan_numbers)) AS pan_number
FROM [dbo].[PAN Number Validation Dataset]
WHERE pan_numbers IS NOT NULL;

------------- FUNCTIONS -----------------------

-- Function to check if adjacent characters are repetative. 
-- Returns true if adjacent characters are adjacent else returns false

CREATE OR ALTER FUNCTION dbo.fn_check_str (@p_str nvarchar(MAX))
RETURNS BIT
AS
BEGIN
    DECLARE @i INT = 1;
	DECLARE @len INT = LEN(@p_str);
    -- WHILE Loop Simulation
    WHILE @i < @len
    BEGIN
        IF SUBSTRING(@p_str ,@i ,1) = SUBSTRING(@p_str ,@i + 1 ,1)  -- IF statement inside a while loop
		  RETURN 1;
        SET @i = @i + 1;  -- Increment the counter
    END
    RETURN 0;
END;
GO

-- Calling the fn_check_str function
SELECT dbo.fn_check_str ('DEERG');
SELECT dbo.fn_check_str ('DERGH');

----------------------------------------

-- Function to check if characters are sequential. 
-- Returns true if characters are sequential else returns false

CREATE OR ALTER FUNCTION dbo.fn_sequential_str (@p_str nvarchar(MAX))
RETURNS BIT
AS
BEGIN
    DECLARE @i INT = 1;
	DECLARE @len INT = LEN(@p_str);
    -- WHILE Loop Simulation
    WHILE @i < @len
    BEGIN
        IF ASCII(SUBSTRING(@p_str ,@i + 1, 1)) - ASCII(SUBSTRING(@p_str ,@i ,1)) <> 1  -- <> = NOT EQUAL TO
		  RETURN 0;
        SET @i = @i + 1;  -- Increment the counter
    END
    RETURN 1;
END;
GO

-- Calling the fn_sequential_str function
SELECT dbo.fn_sequential_str('ABCDE');
SELECT dbo.fn_sequential_str('ADFRB');


-- Create view with all the cleaning conditions

CREATE OR ALTER VIEW vw_valid_invalid_pans
AS
WITH cte_cleaned_pan AS
(
    SELECT DISTINCT
           UPPER(LTRIM(RTRIM(pan_numbers))) AS pan_numbers
    FROM [dbo].[PAN Number Validation Dataset]
    WHERE pan_numbers IS NOT NULL
      AND LTRIM(RTRIM(pan_numbers)) <> ''
),
cte_valid_pan AS
(
    SELECT *
    FROM cte_cleaned_pan
    WHERE dbo.fn_check_str(pan_numbers) = 0
      AND dbo.fn_sequential_str(SUBSTRING(pan_numbers, 1, 5)) = 0
      AND dbo.fn_sequential_str(SUBSTRING(pan_numbers, 6, 4)) = 0
      AND pan_numbers LIKE '[A-Z][A-Z][A-Z][A-Z][A-Z][0-9][0-9][0-9][0-9][A-Z]'
)
SELECT
    cln.pan_numbers,
    CASE
        WHEN vld.pan_numbers IS NULL
            THEN 'Invalid PAN'
        ELSE 'Valid PAN'
    END AS status
FROM cte_cleaned_pan cln
LEFT JOIN cte_valid_pan vld
    ON vld.pan_numbers = cln.pan_numbers;
GO


